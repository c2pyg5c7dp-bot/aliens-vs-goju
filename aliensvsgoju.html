<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover,interactive-widget=resizes-content" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Aliens vs Goju</title>
  <link rel="stylesheet" href="./style.css">
  <!-- PeerJS for P2P multiplayer -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    /* iOS Safe Area Support */
    @supports(padding: max(0px)) {
      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
      }
    }
  </style>
</head>
<body>
  <script src="./init-debug.js?v=5"></script>
  
  <div id="loading-screen" class="loading-screen-overlay">
    <div style="text-align: center; color: #fff;">
      <h2>Loading Game...</h2>
      <p id="loading-status">Initializing Discord SDK...</p>
      <div id="loading-details" style="font-size: 10px; opacity: 0.5; margin-top: 20px;">
        <div id="loading-discord">❓ Discord SDK</div>
        <div id="loading-game">❓ Game Engine</div>
        <div id="loading-animations">❓ Animations</div>
      </div>
      <p style="font-size: 12px; opacity: 0.5; margin-top: 20px;">Press F12 to view console if stuck</p>
    </div>
  </div>

  <script src="./loading-timeout.js?v=5"></script>

  <!-- Start Menu Music -->
  <audio id="startMenuMusic" loop autoplay muted style="display:none;">
    <source src="startmenumusic.ogg" type="audio/ogg">
  </audio>

  <div id="startScreen" class="overlay" style="background:none; display:flex; align-items:center; justify-content:center;">
    <div class="start-screen-image" style="position:fixed; width:100%; height:100%; background-image:url('startscreenaliens.png'); background-size:cover; background-position:center; background-attachment:fixed; display:flex; align-items:center; justify-content:center; top:0; left:0;">
      
      <!-- Click to Start Prompt -->
      <div id="clickToStart" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.8); padding:30px 60px; border-radius:10px; font-size:32px; color:#fff; text-align:center; z-index:1000; pointer-events:none; animation:pulse 2s infinite;">
        Click anywhere to start
      </div>
      
      <!-- Buttons positioned as overlays on image text -->
      <!-- START button -->
      <button id="startBtn" class="image-overlay-btn" style="position:fixed; top:63%; left:1%; width:18%; height:6%; background:rgba(0,0,0,0); border:none; cursor:pointer; z-index:10;" title="Start Game"></button>
      
      <!-- CO-OP button -->
      <button id="coopBtn" class="image-overlay-btn" style="position:fixed; top:71%; left:1%; width:18%; height:6%; background:rgba(0,0,0,0); border:none; cursor:pointer; z-index:10;" title="Co-op"></button>
      
      <!-- UPGRADES button -->
      <button id="upgradesBtn" class="image-overlay-btn" style="position:fixed; top:78%; left:1%; width:18%; height:6%; background:rgba(0,0,0,0); border:none; cursor:pointer; z-index:10;" title="Upgrades"></button>
      
      <!-- OPTIONS button -->
      <button id="optionsBtn" class="image-overlay-btn" style="position:fixed; top:87%; left:1%; width:18%; height:6%; background:rgba(0,0,0,0); border:none; cursor:pointer; z-index:10;" title="Options"></button>
      
      <!-- EXIT button -->
      <button id="exitBtn" class="image-overlay-btn" style="position:fixed; top:95%; left:1%; width:18%; height:6%; background:rgba(0,0,0,0); border:none; cursor:pointer; z-index:10;" title="Exit"></button>
    </div>
  </div>

  <!-- Upgrades Screen -->
  <div id="upgradesScreen" class="overlay" style="display:none">
    <div class="panel" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h1 style="margin-top: 0;">💎 Permanent Upgrades</h1>
      <div style="text-align: center; margin-bottom: 20px;">
        <p style="font-size: 24px; color: #ffff00;">Total Gems: <span id="totalGemsUpgrade">0</span></p>
        <p style="font-size: 14px; opacity: 0.7;">Upgrades persist between runs!</p>
      </div>

      <div id="upgradesList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin: 20px 0;">
        <!-- Upgrades will be generated by JavaScript -->
      </div>

      <button id="closeUpgrades" class="menu-btn" style="margin-top: 20px; background: #666;">← Back to Menu</button>
    </div>
  </div>

  <!-- Options Screen -->
  <div id="optionsScreen" class="overlay" style="display:none">
    <div class="panel" style="max-width: 500px;">
      <h1 style="margin-top: 0;">⚙️ Options</h1>
      
      <div style="margin: 30px 0;">
        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 25px;">
          <label style="font-size: 18px; min-width: 120px; color: #7ee787;">🔊 Volume:</label>
          <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
            <input type="range" id="volumeSlider" min="0" max="100" value="30" style="flex: 1; cursor: pointer; height: 6px;">
            <span id="volumePercent" style="min-width: 40px; text-align: right; color: #fff;">30%</span>
          </div>
        </div>
        
        <div style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; margin-bottom: 20px;">
          <p style="margin: 0; font-size: 14px; opacity: 0.8;">Adjust the volume of all game sounds and music</p>
        </div>
      </div>

      <button id="closeOptions" class="menu-btn" style="background: #2196F3;">← Back to Menu</button>
    </div>
  </div>

  <!-- Join Lobby Modal -->
  <div id="joinLobbyModal" class="modal-overlay" style="display:none; z-index: 1000;">
    <div class="modal-content">
      <h2 style="margin-top: 0;">🔗 Join Lobby</h2>
      <p style="opacity: 0.8; margin-bottom: 10px;">Enter the FULL code shared by your friend</p>
      <p style="font-size: 12px; opacity: 0.6; margin-bottom: 20px; color: #7ee787;">
        Format: <code style="background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 3px;">ABCD|peer-id-string</code>
      </p>
      
      <div style="margin: 20px 0;">
        <input 
          type="text" 
          id="lobbyCodeInput" 
          maxlength="100" 
          placeholder="Paste full code here..."
          style="font-size: 14px; font-weight: bold; letter-spacing: 1px; text-align: center; padding: 15px; background: rgba(0,0,0,0.5); border: 2px solid #2196F3; border-radius: 8px; color: #2196F3; width: 100%; font-family: monospace;"
        >
        <p id="joinError" style="color: #f44336; margin: 10px 0 0 0; min-height: 20px; font-size: 14px;"></p>
      </div>

      <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
        <button id="joinLobbyConfirm" class="menu-btn" style="background: #2196F3; flex: 1; max-width: 150px; cursor: pointer; border: none; color: white; font-weight: bold; padding: 12px; border-radius: 4px; transition: all 0.3s;" onmouseover="this.style.background='#1976D2'; this.style.boxShadow='0 4px 12px rgba(33, 150, 243, 0.6)'" onmouseout="this.style.background='#2196F3'; this.style.boxShadow='none'">
          ✓ Join
        </button>
        <button id="joinLobbyCancel" class="menu-btn" style="background: #666; flex: 1; max-width: 150px; cursor: pointer; border: none; color: white; font-weight: bold; padding: 12px; border-radius: 4px; transition: all 0.3s;" onmouseover="this.style.background='#888'; this.style.boxShadow='0 4px 12px rgba(136, 136, 136, 0.6)'" onmouseout="this.style.background='#666'; this.style.boxShadow='none'">
          ✗ Cancel
        </button>
      </div>
    </div>
  </div>

  <div id="lobbyScreen" class="overlay" style="display:none">
    <div class="panel">
      <h1>🎮 Co-op Lobby</h1>
      <div style="text-align: center; color: var(--fg);">
        
        <!-- Join Game Button -->
        <div style="margin: 20px 0; padding: 15px; background: rgba(33, 150, 243, 0.2); border-radius: 8px; border: 2px solid #2196F3;">
          <h3 style="margin: 0 0 10px 0;">🎮 Join a Game</h3>
          <p style="font-size: 12px; opacity: 0.7; margin: 0 0 15px 0;">Join an existing co-op lobby using a code</p>
          <button id="joinGameBtn" style="background: #2196F3; color: white; border: none; padding: 12px 24px; font-size: 16px; font-weight: bold; border-radius: 4px; cursor: pointer; transition: all 0.3s; width: 100%; max-width: 200px; z-index: 100;" onmouseover="this.style.background='#1976D2'; this.style.boxShadow='0 4px 12px rgba(33, 150, 243, 0.6)'" onmouseout="this.style.background='#2196F3'; this.style.boxShadow='none'">🔗 Join Game</button>
        </div>

        <!-- Lobby Code / Invite Section -->
        <div style="margin: 20px 0; padding: 15px; background: rgba(76, 175, 80, 0.2); border-radius: 8px; border: 2px solid #4CAF50;">
          <h3 style="margin: 0 0 10px 0;">📋 Lobby Code (You are HOST)</h3>
          <div style="display: flex; gap: 10px; align-items: center; justify-content: center;">
            <input type="text" id="lobbyCodeDisplay" readonly style="font-size: 16px; font-weight: bold; letter-spacing: 1px; text-align: center; padding: 10px; background: rgba(0,0,0,0.5); border: 2px solid #4CAF50; border-radius: 4px; color: #4CAF50; width: 100%; max-width: 400px; font-family: monospace;" value="XXXX">
          </div>
          <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
            <button id="copyLobbyCode" style="background: #4CAF50; padding: 10px 20px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='#4CAF50'">📋 Copy Code</button>
            <button id="shareLobbyCode" style="background: #2196F3; padding: 10px 20px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#1976D2'" onmouseout="this.style.background='#2196F3'">🔗 Share Link</button>
          </div>
          <p style="font-size: 12px; opacity: 0.8; margin: 10px 0 0 0; color: #7ee787;">
            <strong>⚠️ Important:</strong> Share the FULL code above (including everything after the | symbol). Friends paste it in "Join Game".
          </p>
        </div>

        <!-- Character Selection in Lobby -->
        <div style="margin: 20px 0; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
          <h3>🎭 Choose Your Character</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 15px 0;">
            <div class="lobby-char-card" data-character="player" style="cursor: pointer; padding: 10px; background: rgba(255,255,255,0.1); border: 2px solid transparent; border-radius: 8px; transition: all 0.3s;">
              <div style="font-size: 40px;">🧙</div>
              <div style="font-weight: bold;">Player</div>
              <div style="font-size: 11px; opacity: 0.7;">Balanced</div>
            </div>
            <div class="lobby-char-card" data-character="tank" style="cursor: pointer; padding: 10px; background: rgba(255,255,255,0.1); border: 2px solid transparent; border-radius: 8px; transition: all 0.3s;">
              <div style="font-size: 40px;">🛡️</div>
              <div style="font-weight: bold;">Tank</div>
              <div style="font-size: 11px; opacity: 0.7;">Tanky</div>
            </div>
            <div class="lobby-char-card" data-character="speedster" style="cursor: pointer; padding: 10px; background: rgba(255,255,255,0.1); border: 2px solid transparent; border-radius: 8px; transition: all 0.3s;">
              <div style="font-size: 40px;">⚡</div>
              <div style="font-weight: bold;">Speedster</div>
              <div style="font-size: 11px; opacity: 0.7;">Fast</div>
            </div>
            <div class="lobby-char-card" data-character="glass-cannon" style="cursor: pointer; padding: 10px; background: rgba(255,255,255,0.1); border: 2px solid transparent; border-radius: 8px; transition: all 0.3s;">
              <div style="font-size: 40px;">💥</div>
              <div style="font-weight: bold;">Glass Cannon</div>
              <div style="font-size: 11px; opacity: 0.7;">High DMG</div>
            </div>
          </div>
          <p id="yourCharacterSelection" style="font-size: 14px; color: #4CAF50; font-weight: bold; margin: 10px 0 0 0;">Your character: <span id="selectedCharName">None</span></p>
        </div>

        <p id="lobbyStatus">Waiting for players...</p>
        <div id="playersList" style="margin: 20px 0; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 8px;">
          <h3>👥 Players in Lobby:</h3>
          <div id="playersListContent" style="display: flex; flex-direction: column; gap: 10px;">
            <p>Loading...</p>
          </div>
        </div>
        <button id="startCoopBtn" style="background: #4CAF50; padding: 12px 24px; font-size: 16px; font-weight: bold; border: none; color: white; border-radius: 4px; cursor: pointer; transition: all 0.3s;">⚡ Ready Up</button>
        <button id="leaveLobbyBtn" style="background: #f44336; margin-left: 12px; padding: 12px 24px;">❌ Leave Lobby</button>
      </div>
    </div>
  </div>

  <div id="charSelectScreen" class="overlay" style="display:none">
    <div class="char-select-menu">
      <!-- Animated background particles -->
      <div class="particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
      </div>
      
      <div class="menu-content">
        <div class="char-select-header">
          <h1 class="title-main" style="font-size: 48px;">CHOOSE</h1>
          <h2 class="title-sub">YOUR HERO</h2>
        </div>
        
        <div class="character-grid-modern">
          <div class="character-card-modern" data-character="player">
            <div class="char-image-container">
              <img src="./animations/Player/rotations/south.png" alt="Player" class="char-image">
              <div class="char-glow"></div>
            </div>
            <h3 class="char-name">🧙 Mage</h3>
            <p class="char-desc-modern">Balanced warrior</p>
            <div class="char-stats-modern">
              <div class="stat-item"><span class="stat-icon">❤️</span> 12</div>
              <div class="stat-item"><span class="stat-icon">⚡</span> 220</div>
              <div class="stat-item"><span class="stat-icon">⚔️</span> 1.0</div>
              <div class="stat-item"><span class="stat-icon">🔥</span> 0.12</div>
            </div>
            <div class="char-select-btn">SELECT</div>
          </div>
          
          <div class="character-card-modern" data-character="tank">
            <div class="char-image-container">
              <img src="./animations/Player/rotations/south.png" alt="Tank" class="char-image" style="filter: hue-rotate(25deg) saturate(0.6) brightness(0.9);">
              <div class="char-glow"></div>
            </div>
            <h3 class="char-name">🛡️ Tank</h3>
            <p class="char-desc-modern">Unstoppable fortress</p>
            <div class="char-stats-modern">
              <div class="stat-item"><span class="stat-icon">❤️</span> 20</div>
              <div class="stat-item"><span class="stat-icon">⚡</span> 180</div>
              <div class="stat-item"><span class="stat-icon">⚔️</span> 1.5</div>
              <div class="stat-item"><span class="stat-icon">🔥</span> 0.18</div>
            </div>
            <div class="char-select-btn">SELECT</div>
          </div>
          
          <div class="character-card-modern" data-character="speedster">
            <div class="char-image-container">
              <img src="./animations/Player/rotations/south.png" alt="Speedster" class="char-image" style="filter: hue-rotate(120deg);">
              <div class="char-glow"></div>
            </div>
            <h3 class="char-name">⚡ Speedster</h3>
            <p class="char-desc-modern">Lightning fast</p>
            <div class="char-stats-modern">
              <div class="stat-item"><span class="stat-icon">❤️</span> 8</div>
              <div class="stat-item"><span class="stat-icon">⚡</span> 300</div>
              <div class="stat-item"><span class="stat-icon">⚔️</span> 0.7</div>
              <div class="stat-item"><span class="stat-icon">🔥</span> 0.08</div>
            </div>
            <div class="char-select-btn">SELECT</div>
          </div>
          
          <div class="character-card-modern" data-character="glass_cannon">
            <div class="char-image-container">
              <img src="./animations/Player/rotations/south.png" alt="Glass Cannon" class="char-image" style="filter: hue-rotate(240deg);">
              <div class="char-glow"></div>
            </div>
            <h3 class="char-name">💥 Glass Cannon</h3>
            <p class="char-desc-modern">Maximum firepower</p>
            <div class="char-stats-modern">
              <div class="stat-item"><span class="stat-icon">❤️</span> 6</div>
              <div class="stat-item"><span class="stat-icon">⚡</span> 200</div>
              <div class="stat-item"><span class="stat-icon">⚔️</span> 2.0</div>
              <div class="stat-item"><span class="stat-icon">🔥</span> 0.10</div>
            </div>
            <div class="char-select-btn">SELECT</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stage Select Screen -->
  <div id="stageSelectScreen" class="overlay" style="display:none">
    <div class="stage-select-container">
      <div class="stage-select-header">
        <h1 style="font-size: 48px; margin: 0; color: #0f0; text-shadow: 0 0 20px rgba(0,255,0,0.8);">SELECT STAGE</h1>
      </div>
      
      <div class="stage-select-grid">
        <!-- Stage 1 -->
        <div class="stage-select-card unlocked" data-stage="1">
          <div class="stage-num">1</div>
          <div class="stage-title">HOME GROUND</div>
          <div class="stage-status">✓ Available</div>
          <button class="stage-play-btn">PLAY</button>
        </div>
        
        <!-- Stage 2 -->
        <div class="stage-select-card locked" data-stage="2">
          <div class="stage-num">2</div>
          <div class="stage-title">COMING SOON</div>
          <div class="stage-status">🔒 Locked</div>
          <div class="stage-requirement">Reach Wave 20 on Stage 1</div>
          <div class="stage-progress"><span id="stage2-progress">0</span>/20</div>
        </div>
        
        <!-- Stage 3 -->
        <div class="stage-select-card locked" data-stage="3">
          <div class="stage-num">3</div>
          <div class="stage-title">COMING SOON</div>
          <div class="stage-status">🔒 Locked</div>
          <div class="stage-requirement">Reach Wave 20 on Stage 2</div>
          <div class="stage-progress"><span id="stage3-progress">0</span>/20</div>
        </div>
      </div>
      
      <button id="backToCharSelect" class="back-btn">← BACK</button>
    </div>
  </div>

  <div id="ui">
    <div id="hud">
      <div class="hud-stat">
        <span class="hud-icon">💎</span>
        <span class="hud-label">Score</span>
        <span id="score" class="hud-value">0</span>
      </div>
      <div class="hud-stat">
        <span class="hud-icon">❤️</span>
        <span class="hud-label">Health</span>
        <div class="health-bar-container">
          <div id="healthBar" class="health-bar"></div>
          <span id="health" class="hud-value-overlay">10/10</span>
        </div>
      </div>
      <div class="hud-stat">
        <span class="hud-icon">🌊</span>
        <span class="hud-label">Wave</span>
        <span id="wave" class="hud-value">0</span>
      </div>
      <div class="hud-stat">
        <span class="hud-icon">⏱️</span>
        <span class="hud-label">Time</span>
        <span id="timer" class="hud-value">0s</span>
      </div>
      <div class="hud-stat">
        <span class="hud-icon">⚡</span>
        <span class="hud-label">Dash</span>
        <span id="dashCharges" class="hud-value">●●●</span>
      </div>
      <div id="powerups" class="hud-stat" style="display:block; flex-direction:column; align-items:flex-start;"></div>
      <div class="buttons">
        <button id="pauseBtn">⏸ Pause</button>
        <button id="restartBtn">🔄 Reset</button>
        <button id="leaderboardBtn">🏆 Board</button>
      </div>
    </div>
  </div>

  <style>
    #hud {
      position: absolute;
      top: 10px;
      right: 10px;
      background: linear-gradient(135deg, rgba(20, 20, 40, 0.95), rgba(40, 20, 60, 0.95));
      padding: 8px;
      border-radius: 6px;
      border: 2px solid rgba(138, 43, 226, 0.6);
      box-shadow: 0 0 20px rgba(138, 43, 226, 0.4), inset 0 0 20px rgba(0, 0, 0, 0.3);
      font-family: 'Courier New', monospace;
      color: #fff;
      min-width: 120px;
      backdrop-filter: blur(5px);
    }

    .hud-stat {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      padding: 4px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
      transition: all 0.3s;
    }

    .hud-stat:hover {
      background: rgba(138, 43, 226, 0.2);
      transform: translateX(-5px);
    }

    .hud-icon {
      font-size: 14px;
      margin-right: 6px;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .hud-label {
      font-size: 9px;
      color: #aaa;
      margin-right: 4px;
      min-width: 32px;
    }

    .hud-value {
      font-size: 12px;
      font-weight: bold;
      color: #0ff;
      text-shadow: 0 0 5px #0ff;
      margin-left: auto;
    }

    .health-bar-container {
      flex: 1;
      height: 18px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 9px;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .health-bar {
      height: 100%;
      background: linear-gradient(90deg, #ff4444, #ff6666);
      border-radius: 9px;
      transition: width 0.5s;
      box-shadow: 0 0 10px #ff4444;
      width: 100%;
    }

    .hud-value-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 10px;
      font-weight: bold;
      color: #fff;
      text-shadow: 0 0 3px #000, 1px 1px 2px #000;
      pointer-events: none;
    }

    .hud-powerups {
      margin: 8px 0;
      padding: 8px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 6px;
      min-height: 30px;
      font-size: 10px;
    }

    #hud .buttons {
      display: flex;
      gap: 4px;
      margin-top: 6px;
    }

    #hud .buttons button {
      flex: 1;
      padding: 4px 6px;
      background: linear-gradient(135deg, #6a0dad, #8a2be2);
      border: 1px solid #a855f7;
      border-radius: 3px;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 8px;
      text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
    }

    #hud .buttons button:hover {
      background: linear-gradient(135deg, #8a2be2, #9370db);
      box-shadow: 0 0 15px rgba(138, 43, 226, 0.6);
      transform: translateY(-2px);
    }

    #hud .buttons button:active {
      transform: translateY(0);
    }

    .character-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 20px;
      max-width: 800px;
    }

    .character-card {
      background: linear-gradient(135deg, rgba(40, 20, 60, 0.95), rgba(20, 20, 40, 0.95));
      border: 2px solid rgba(138, 43, 226, 0.6);
      border-radius: 10px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 0 15px rgba(138, 43, 226, 0.3);
    }

    .character-card:hover {
      transform: translateY(-5px);
      border-color: rgba(138, 43, 226, 1);
      box-shadow: 0 0 25px rgba(138, 43, 226, 0.6);
    }

    .character-card h3 {
      margin: 0 0 10px 0;
      color: #fff;
      font-size: 24px;
      text-align: center;
    }

    .char-desc {
      color: #aaa;
      font-style: italic;
      text-align: center;
      margin: 0 0 15px 0;
      font-size: 14px;
    }

    .char-stats {
      color: #fff;
      font-size: 14px;
      line-height: 1.8;
    }

    .char-stats div {
      padding: 3px 0;
    }
  </style>

  <canvas id="game"></canvas>

  <div id="rewardModal" class="modal" style="display:none">
    <div class="modal-content">
      <h3>Choose a Reward</h3>
      <div class="choices">
        <button id="rewardHealth">+Health</button>
        <button id="rewardDamage">+Damage</button>
        <button id="rewardRate">Faster Fire</button>
        <button id="rewardSpeed">+Speed</button>
        <button id="rewardMagnet">+Magnet</button>
      </div>
    </div>
  </div>

  <!-- Debug menu toggle tab for mobile -->
  <div id="dbgTab" style="position:fixed; bottom:10px; right:10px; width:50px; height:50px; background:#0f0; color:#000; border:2px solid #0f0; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:18px; cursor:pointer; z-index:998; box-shadow:0 2px 10px rgba(0,255,0,0.5);">🐛</div>

  <div id="testRunner" style="position:fixed; bottom:10px; right:10px; width:320px; max-height:70vh; background:#222; color:#0f0; border:2px solid #0f0; padding:8px; font-family:monospace; font-size:11px; overflow-y:scroll; z-index:999; display:none; transition:transform 0.3s ease; touch-action:pan-y;">
    <div style="display:flex; justify-content:space-between; align-items:center; font-weight:bold; margin-bottom:6px">
      <button id="dbgMinimize" style="background:#0f0; color:#000; border:none; cursor:pointer; padding:2px 8px; font-weight:bold; border-radius:3px">−</button>
      <span>🐛 Debug Console</span>
    </div>
    <div id="dbgContent" style="max-height:calc(70vh - 40px); overflow-y:auto;">
    <div style="display:flex; gap:6px; margin-bottom:6px; align-items:center">
      <label style="font-size:11px"><input type="checkbox" id="dbgAuto"/> Live</label>
      <button id="dbgLogState" style="flex:1; padding:4px; background:#0f0; color:#000; border:none; cursor:pointer">Log State</button>
    </div>
    <div id="dbgStats" style="font-size:12px; color:#9f9; margin-bottom:6px; line-height:1.25">
      <div>Score: <span id="dbgScore">0</span></div>
      <div>Wave: <span id="dbgWave">0</span></div>
      <div>Enemies: <span id="dbgEnemies">0</span>  Projectiles: <span id="dbgProjectiles">0</span></div>
      <div>Powerups: <span id="dbgPowerups">0</span>  Gems: <span id="dbgGems">0</span></div>
      <div>Player HP: <span id="dbgHP">0</span></div>
      <div>Fired Shots: <span id="dbgFired">0</span></div>
    </div>
    <div style="margin-bottom:8px; padding:8px; background:#111; border:1px solid #0f0; border-radius:4px">
      <div style="font-weight:bold; margin-bottom:4px; color:#ff0">Enemy Speed Control</div>
      <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px">
        <label style="flex:1">Speed: <span id="enemySpeedValue">198</span></label>
        <button id="enemySpeedDec" style="padding:4px 8px; background:#f00; color:#000; border:none; cursor:pointer">-</button>
        <button id="enemySpeedInc" style="padding:4px 8px; background:#0f0; color:#000; border:none; cursor:pointer">+</button>
      </div>
      <input type="range" id="enemySpeedSlider" min="50" max="300" value="198" step="1" style="width:100%"/>
      <div style="font-size:10px; color:#999; margin-top:2px">Player: 220 | Current: <span id="enemySpeedPercent">90%</span></div>
    </div>
    <div id="testOutput" style="background:#000; color:#0f0; padding:6px; height:120px; overflow:auto; border:1px solid #0f0"></div>
    <div style="display:flex; gap:6px; margin-top:6px">
      <button id="dbgClear" style="padding:4px; background:#333; color:#0f0; border:1px solid #0f0; cursor:pointer">Clear</button>
      <button id="runTestBtn" style="padding:4px; background:#0f0; color:#000; border:none; cursor:pointer">Run Tests</button>
      <button id="dbgSpawnWave" style="padding:4px; background:#0f0; color:#000; border:none; cursor:pointer">Spawn Wave</button>
    </div>
    <div style="display:flex; gap:6px; margin-top:6px">
      <button id="dbgLoadAnim" style="flex:1; padding:4px; background:#0f0; color:#000; border:none; cursor:pointer">Load Anim</button>
      <select id="dbgAnimList" style="flex:1; padding:4px; background:#111; color:#0f0; border:1px solid #0f0"></select>
      <button id="dbgSpawnAnim" style="flex:1; padding:4px; background:#0f0; color:#000; border:none; cursor:pointer">Spawn Anim</button>
    </div>
    <div style="display:flex; gap:6px; margin-top:6px">
      <button id="dbgSimFire" style="flex:1; padding:4px; background:#0f0; color:#000; border:none; cursor:pointer">Sim Fire</button>
      <button id="dbgStart" style="flex:1; padding:4px; background:#0f0; color:#000; border:none; cursor:pointer">Start</button>
    </div>
    <div style="display:flex; gap:6px; margin-top:6px">
      <button id="skipWave" style="flex:1; padding:4px; background:#ffa500; color:#000; border:none; cursor:pointer; font-weight:bold">Skip Wave</button>
      <button id="skipTo20" style="flex:1; padding:4px; background:#ff4444; color:#fff; border:none; cursor:pointer; font-weight:bold">Skip to Wave 20</button>
    </div>
    <div style="display:flex; gap:6px; margin-top:6px; align-items:center">
      <label style="flex:1; font-size:11px">Go to Wave:</label>
      <input id="waveInput" type="number" min="1" max="100" value="1" style="flex:1; padding:4px; background:#111; color:#0f0; border:1px solid #0f0; text-align:center"/>
      <button id="goToWave" style="flex:1; padding:4px; background:#00ffff; color:#000; border:none; cursor:pointer; font-weight:bold">GO</button>
    </div>
    <div style="margin-top:8px; padding:8px; background:#111; border:1px solid #0f0; border-radius:4px">
      <div style="font-weight:bold; margin-bottom:4px; color:#ff0">Spawn Powerups</div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:4px">
        <button id="spawnMinigun" style="padding:4px; background:#7fe8ff; color:#000; border:none; cursor:pointer; font-size:10px">Minigun</button>
        <button id="spawnRocket" style="padding:4px; background:#ffb27f; color:#000; border:none; cursor:pointer; font-size:10px">Rocket</button>
        <button id="spawnShotgun" style="padding:4px; background:#d19cff; color:#000; border:none; cursor:pointer; font-size:10px">Shotgun</button>
        <button id="spawnFireball" style="padding:4px; background:#4da6ff; color:#000; border:none; cursor:pointer; font-size:10px">Fireball</button>
        <button id="spawnSword" style="padding:4px; background:#c0c0c0; color:#000; border:none; cursor:pointer; font-size:10px">Sword</button>
        <button id="spawnSpeed" style="padding:4px; background:#00ff88; color:#000; border:none; cursor:pointer; font-size:10px">Speed</button>
        <button id="spawnX2Score" style="padding:4px; background:#ffa500; color:#000; border:none; cursor:pointer; font-size:10px; font-weight:bold">X2 SCORE</button>
        <button id="spawnNuke" style="padding:4px; background:#ffff00; color:#000; border:none; cursor:pointer; font-size:10px; font-weight:bold">NUKE</button>
        <button id="spawnGem" style="padding:4px; background:#fff28f; color:#000; border:none; cursor:pointer; font-size:10px">Gem</button>
        <button id="spawnHeart" style="padding:4px; background:#ff69b4; color:#000; border:none; cursor:pointer; font-size:10px">Heart</button>
        <button id="spawnRedAlien" style="padding:4px; background:#ff3333; color:#fff; border:none; cursor:pointer; font-size:10px; font-weight:bold">RED ALIEN</button>
        <button id="spawnBoss" style="padding:4px; background:#ff0000; color:#fff; border:none; cursor:pointer; font-size:10px; font-weight:bold">BOSS</button>
      </div>
    </div>
    <div style="margin-top:8px; padding:8px; background:#111; border:1px solid #0f0; border-radius:4px">
      <div style="font-weight:bold; margin-bottom:4px; color:#ff0">⚡ Player Upgrades</div>
      <div style="display:grid; gap:4px">
        <div style="display:flex; align-items:center; gap:6px">
          <label style="flex:1; font-size:10px">Damage: <span id="damageValue">5</span></label>
          <button id="damageDec" style="padding:2px 6px; background:#f00; color:#000; border:none; cursor:pointer">-</button>
          <button id="damageInc" style="padding:2px 6px; background:#0f0; color:#000; border:none; cursor:pointer">+</button>
        </div>
        <div style="display:flex; align-items:center; gap:6px">
          <label style="flex:1; font-size:10px">Fire Rate: <span id="fireRateValue">0.16</span></label>
          <button id="fireRateDec" style="padding:2px 6px; background:#f00; color:#000; border:none; cursor:pointer">-</button>
          <button id="fireRateInc" style="padding:2px 6px; background:#0f0; color:#000; border:none; cursor:pointer">+</button>
        </div>
        <div style="display:flex; align-items:center; gap:6px">
          <label style="flex:1; font-size:10px">Max HP: <span id="maxHPValue">20</span></label>
          <button id="maxHPDec" style="padding:2px 6px; background:#f00; color:#000; border:none; cursor:pointer">-</button>
          <button id="maxHPInc" style="padding:2px 6px; background:#0f0; color:#000; border:none; cursor:pointer">+</button>
        </div>
        <div style="display:flex; align-items:center; gap:6px">
          <label style="flex:1; font-size:10px">Speed: <span id="speedValue">220</span></label>
          <button id="speedDec" style="padding:2px 6px; background:#f00; color:#000; border:none; cursor:pointer">-</button>
          <button id="speedInc" style="padding:2px 6px; background:#0f0; color:#000; border:none; cursor:pointer">+</button>
        </div>
        <div style="display:flex; gap:4px; margin-top:4px">
          <button id="healFull" style="flex:1; padding:4px; background:#ff69b4; color:#000; border:none; cursor:pointer; font-size:10px; font-weight:bold">HEAL FULL</button>
          <button id="godMode" style="flex:1; padding:4px; background:#ffff00; color:#000; border:none; cursor:pointer; font-size:10px; font-weight:bold">GOD MODE</button>
        </div>
      </div>
    </div>
    <div style="margin-top:8px; padding:8px; background:#111; border:1px solid #0f0; border-radius:4px">
      <div style="font-weight:bold; margin-bottom:4px; color:#ff0">🎮 Lobby Debug</div>
      <div id="lobbyDebugSection" style="font-size:10px; color:#0f0; line-height:1.4">Waiting for lobby events...</div>
    </div>
    <div style="margin-top:8px; padding:8px; background:#111; border:1px solid #0f0; border-radius:4px">
      <div style="font-weight:bold; margin-bottom:4px; color:#ff0">🚀 Init Debug</div>
      <div id="initDebugSection" style="font-size:10px; color:#0f0; line-height:1.4"></div>
    </div>
    <div style="margin-top:8px; padding:8px; background:#111; border:1px solid #2196F3; border-radius:4px">
      <div style="font-weight:bold; margin-bottom:4px; color:#2196F3">🌐 Multiplayer Status</div>
      <div id="multiplayerDebugSection" style="font-size:10px; color:#64B5F6; line-height:1.6">
        <div>PeerJS: <span id="peerJsStatus">❓</span></div>
        <div>NetworkManager: <span id="networkManagerStatus">❓</span></div>
        <div>Peer Connection: <span id="peerConnectionStatus">❓</span></div>
        <div>Local Peer ID: <span id="localPeerId" style="color:#00ff00; font-family:monospace; font-size:9px">N/A</span></div>
        <div>Room Code: <span id="roomCodeStatus" style="color:#00ff00; font-weight:bold">None</span></div>
        <div>Is Host: <span id="isHostStatus">❓</span></div>
        <div>Connected Players: <span id="connectedPlayersCount">0</span></div>
        <div style="margin-top:4px; padding-top:4px; border-top:1px solid #333; display:flex; gap:4px; flex-direction:column;">
          <button id="mpRefreshStatus" style="padding:4px 8px; background:#2196F3; color:#000; border:none; cursor:pointer; font-size:10px; font-weight:bold; width:100%">🔄 Refresh Status</button>
          <button id="mpInitialize" style="padding:4px 8px; background:#4CAF50; color:#000; border:none; cursor:pointer; font-size:10px; font-weight:bold; width:100%">🔌 Initialize PeerJS</button>
        </div>
      </div>
    </div>
    </div>
  </div>

  <!-- Game Over Screen -->
  <div id="gameOverScreen" class="overlay" style="display:none; z-index:1000; background:rgba(0,0,0,0.85); position:fixed; top:0; left:0; width:100vw; height:100vh; justify-content:center; align-items:center;">
    <div style="background:#222; border-radius:16px; box-shadow:0 0 32px #000; padding:40px 32px; text-align:center; max-width:400px; margin:auto; color:#fff;">
      <h1 style="color:#ff4444; margin-bottom:16px;">GAME OVER</h1>
      <div style="font-size:22px; margin-bottom:12px;">Score: <span id="finalScore">0</span></div>
      <div style="font-size:18px; margin-bottom:24px;">Highest Combo: <span id="finalCombo">0</span></div>
      <button id="restartGameBtn" style="padding:12px 32px; font-size:18px; background:#4CAF50; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Restart</button>
      <button id="returnMenuBtn" style="padding:12px 32px; font-size:18px; background:#2196F3; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; margin-left:12px;">Menu</button>
    </div>
  </div>
  <!-- NetworkManager for multiplayer -->
  <script src="./NetworkManager.js?v=1"></script>

  <!-- Lobby functionality loaded as external script for Discord compatibility -->
  <script defer src="./lobby.js?v=7"></script>

  <!-- Multiplayer debug monitor -->
  <script defer src="./debug-multiplayer.js?v=1"></script>

  <!-- Global error handler -->
  <script src="./error-handler.js?v=5"></script>

  <!-- Discord SDK and main initialization -->
  <script type="module" src="./main.js?v=5"></script>
  
  <!-- Game scripts loaded with defer to ensure DOM is ready -->
  <script defer src="./game.main.js?v=20241209-stage-redesign"></script>
  <script defer src="./animations/player-animations.js?v=5"></script>
  <script defer src="./animations/speedster-animations.js?v=2"></script>
  <script defer src="./animations/glass-cannon-animations.js?v=2"></script>
  <script defer src="./animations/enemy-animations.js?v=5"></script>
  <script defer src="./animations/golem-animations.js?v=5"></script>
  <script defer src="./animations/redalien-animations.js?v=5"></script>
  <script defer src="./debug-controls.js?v=6"></script>
  <script defer src="./upgrades.js?v=2"></script>
</body>
</html>
